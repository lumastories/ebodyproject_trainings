var stim_average = ['Stimuli/vAverage1.jpg','Stimuli/vAverage2.jpg','Stimuli/vAverage3.jpg','Stimuli/vAverage4.jpg','Stimuli/vAverage5.jpg','Stimuli/vAverage6.jpg','Stimuli/vAverage7.jpg','Stimuli/vAverage8.jpg','Stimuli/vAverage9.jpg','Stimuli/vAverage10.jpg','Stimuli/vAverage11.jpg','Stimuli/vAverage12.jpg','Stimuli/vAverage13.jpg','Stimuli/vAverage14.jpg','Stimuli/vAverage15.jpg','Stimuli/vAverage16.jpg','Stimuli/vAverage17.jpg','Stimuli/vAverage18.jpg','Stimuli/vAverage19.jpg','Stimuli/vAverage20.jpg','Stimuli/vAverage21.jpg','Stimuli/vAverage22.jpg','Stimuli/vAverage23.jpg','Stimuli/vAverage24.jpg','Stimuli/vAverage25.jpg','Stimuli/vAverage26.jpg','Stimuli/vAverage27.jpg','Stimuli/vAverage28.jpg','Stimuli/vAverage29.jpg','Stimuli/vAverage30.jpg','Stimuli/vAverage31.jpg','Stimuli/vAverage32.jpg','Stimuli/vAverage33.jpg','Stimuli/vAverage34.jpg','Stimuli/vAverage35.jpg','Stimuli/vAverage36.jpg','Stimuli/vAverage37.jpg','Stimuli/vAverage38.jpg','Stimuli/vAverage39.jpg','Stimuli/vAverage40.jpg','Stimuli/vAverage41.jpg','Stimuli/vAverage42.jpg','Stimuli/vAverage43.jpg','Stimuli/vAverage44.jpg','Stimuli/vAverage45.jpg','Stimuli/vAverage46.jpg','Stimuli/vAverage47.jpg','Stimuli/vAverage48.jpg','Stimuli/vAverage49.jpg','Stimuli/vAverage50.jpg','Stimuli/vAverage51.jpg','Stimuli/vAverage52.jpg','Stimuli/vAverage53.jpg','Stimuli/vAverage54.jpg','Stimuli/vAverage55.jpg','Stimuli/vAverage56.jpg','Stimuli/vAverage57.jpg','Stimuli/vAverage58.jpg','Stimuli/vAverage59.jpg','Stimuli/vAverage60.jpg','Stimuli/vAverage61.jpg','Stimuli/vAverage62.jpg','Stimuli/vAverage63.jpg','Stimuli/vAverage64.jpg','Stimuli/vAverage65.jpg','Stimuli/vAverage66.jpg','Stimuli/vAverage67.jpg','Stimuli/vAverage68.jpg','Stimuli/vAverage69.jpeg','Stimuli/vAverage70.jpg','Stimuli/vAverage71.jpg','Stimuli/vAverage72.jpg','Stimuli/vAverage73.jpg','Stimuli/vAverage74.jpg','Stimuli/vAverage75.jpg','Stimuli/vAverage76.jpg','Stimuli/vAverage77.jpg','Stimuli/vAverage78.jpg','Stimuli/vAverage79.jpg','Stimuli/vAverage80.JPG'];
var stim_ultra = ['Stimuli/vUltraT1.jpg', 'Stimuli/vUltraT2.jpg', 'Stimuli/vUltraT3.jpg', 'Stimuli/vUltraT4.jpg', 'Stimuli/vUltraT5.jpg', 'Stimuli/vUltraT6.jpg', 'Stimuli/vUltraT7.jpg', 'Stimuli/vUltraT8.jpg', 'Stimuli/vUltraT9.jpg', 'Stimuli/vUltraT10.jpg', 'Stimuli/vUltraT11.jpg', 'Stimuli/vUltraT12.jpg', 'Stimuli/vUltraT13.jpg', 'Stimuli/vUltraT14.jpg', 'Stimuli/vUltraT15.jpg', 'Stimuli/vUltraT16.jpg', 'Stimuli/vUltraT17.jpg', 'Stimuli/vUltraT18.jpg', 'Stimuli/vUltraT19.jpg', 'Stimuli/vUltraT20.jpg', 'Stimuli/vUltraT21.jpg', 'Stimuli/vUltraT22.jpg', 'Stimuli/vUltraT23.jpg', 'Stimuli/vUltraT24.jpg', 'Stimuli/vUltraT25.jpg', 'Stimuli/vUltraT26.jpg', 'Stimuli/vUltraT27.jpg', 'Stimuli/vUltraT28.jpg', 'Stimuli/vUltraT29.jpg', 'Stimuli/vUltraT30.jpg', 'Stimuli/vUltraT31.jpg', 'Stimuli/vUltraT32.jpg', 'Stimuli/vUltraT33.jpg', 'Stimuli/vUltraT34.jpg', 'Stimuli/vUltraT35.jpg', 'Stimuli/vUltraT36.jpeg', 'Stimuli/vUltraT37.jpg', 'Stimuli/vUltraT38.jpg', 'Stimuli/vUltraT39.jpg', 'Stimuli/vUltraT40.jpg', 'Stimuli/vUltraT41.jpg', 'Stimuli/vUltraT42.jpg', 'Stimuli/vUltraT43.jpg', 'Stimuli/vUltraT44.jpg', 'Stimuli/vUltraT45.jpg', 'Stimuli/vUltraT46.jpg', 'Stimuli/vUltraT47.jpg', 'Stimuli/vUltraT48.jpg', 'Stimuli/vUltraT49.jpg', 'Stimuli/vUltraT50.jpg', 'Stimuli/vUltraT51.jpg', 'Stimuli/vUltraT52.jpg', 'Stimuli/vUltraT53.jpg', 'Stimuli/vUltraT54.jpg', 'Stimuli/vUltraT55.jpg', 'Stimuli/vUltraT56.jpg', 'Stimuli/vUltraT57.jpg', 'Stimuli/vUltraT58.jpg', 'Stimuli/vUltraT59.jpg', 'Stimuli/vUltraT60.JPG', 'Stimuli/vUltraT61.jpg', 'Stimuli/vUltraT62.jpg', 'Stimuli/vUltraT63.jpg', 'Stimuli/vUltraT64.jpg', 'Stimuli/vUltraT65.jpg', 'Stimuli/vUltraT66.jpg', 'Stimuli/vUltraT67.jpg', 'Stimuli/vUltraT68.jpg', 'Stimuli/vUltraT69.jpg', 'Stimuli/vUltraT70.jpg', 'Stimuli/vUltraT71.jpg', 'Stimuli/vUltraT72.jpg', 'Stimuli/vUltraT73.jpg', 'Stimuli/vUltraT74.jpg', 'Stimuli/vUltraT75.jpg', 'Stimuli/vUltraT76.jpg', 'Stimuli/vUltraT77.jpg', 'Stimuli/vUltraT78.jpg', 'Stimuli/vUltraT79.jpg', 'Stimuli/vUltraT80.jpg'];
var RESULTS = [];
var ALL_RESULTS = [];

var MATRIX_X_SIZE = 4;
var MATRIX_Y_SIZE = 4;
var TRIALS_PER_BLOCK = 30;
var BLOCK_NUM = 4;
var TRIAL_COUNT = 0;

function getCoord(){
  var x = Math.floor(Math.random()*10)%MATRIX_X_SIZE;
  var y = Math.floor(Math.random()*10)%MATRIX_X_SIZE;

  return {
          id:'#'+x+y,
          x:x,
          y:y
        }
}

function getScore(){
  return {
    num_correct : _.filter(RESULTS,function(r){return r.correct;}).length,
    percent : Math.floor(100*_.filter(RESULTS,function(r){return r.correct;}).length/RESULTS.length)+'%'
  }
}

function getAverageRT(){
  var total_rt = 0;
  for (var i = RESULTS.length - 1; i >= 0; i--) {
    total_rt += RESULTS[i].rt
  };
  return Math.floor(total_rt/RESULTS.length)+'ms'
}

function buildImageMatrix(incorrect, correct){
  var matrix = [];
  var c = _.sample(correct);
  var inc = _.shuffle(incorrect);
  for (var i = 0; i < MATRIX_X_SIZE; i++) {
    matrix[i] = new Array();
    for (var j = 0; j < MATRIX_Y_SIZE; j++) {
      matrix[i].push(inc.pop())
    }
  }
  correct_coords = [getCoord().x, getCoord().y]
  matrix[correct_coords[0]][correct_coords[1]] = c;
  return matrix;
}

function matrix_to_html(matrix){
  
  var html = "<table>";
  for (var i = 0; i < MATRIX_X_SIZE; i++) {
    html += '<tr>';
    for (var j = 0; j < MATRIX_Y_SIZE; j++) {
      html+="<td><img src='"+matrix[i][j]+"'></td>";
    } 
    html += '</tr>';
  }
  html+="</table>";
  return html;
}
var now = Date.now();

$('body').html("<h2>Instructions</h2> <p>During this game, you will see a grid of 16 photographs of models. It is your job to click on the image of the average weight woman as quickly as you can. This is a tough task! She will be surrounded by ultra-thin women.</p><p>Do your best to respond as quickly and accurately as possible.</p>Click <a href='#' id='skippy'>here</a> to continue.</p>");

function skipOnKey(){
  $('#skippy').on('click', function(){

    $('body').html("<table height=600><tr><td></td><td></td><td></td></tr><tr><td></td><td><center><strong style='font-size:5em;color:#000;'>+</strong></center></td><td></td></tr><tr><td></td><td></td><td></td></tr></table>");
    
    setTimeout(function(){
      $('body').html(matrix_to_html(buildImageMatrix(stim_ultra,stim_average)));
      now = Date.now();
      nextTrialArray();
    }, 500);
  });
}
skipOnKey();
function nextTrialArray(){ 
  $('img').on('click', function(){
    $el = $(this);
    if(String($el.attr('src')).slice(9,10)=='A'){
      $el.parent().addClass('correct');
      $el.addClass('animated tada');
      RESULTS.push({rt:Math.abs(Date.now()-now), correct:true})
    } else {

      $el.parent().addClass('incorrect');
      $el.addClass('animated shake');
      RESULTS.push({rt:Math.abs(Date.now()-now), correct:false})
      $correct_el = $(_.find($('img'), function(img){return $(img).attr('src').slice(9,10)=='A';}));
      $correct_el.parent().addClass('correct');
      $correct_el.addClass('animated wobble');
    }
    
    setTimeout(function(){
      $('body').html("<table height=600><tr><td></td><td></td><td></td></tr><tr><td></td><td><center><strong style='font-size:5em;color:#000;'>+</strong></center></td><td></td></tr><tr><td></td><td></td><td></td></tr></table>");
      TRIAL_COUNT++;
    }, 1000);

    setTimeout(function(){
      if(TRIALS_PER_BLOCK*BLOCK_NUM==TRIAL_COUNT){
          // Last trial scores and ALL scores.
          $('body').html(function(){var score = getScore();
        return "<p>Great work! These are your totals for the game:</p><ul><li><strong># correct</strong> <span style='color:red;'>"+
        score.num_correct+"</span></li><li><strong>% correct</strong> <span style='color:red;'>"+
        score.percent+"</span></li><li><strong>Average RT</strong> <span style='color:red;'>"+
        getAverageRT()+"</span></li></ul> <p>Congratulations on finishing Module 5!</p>";});
      }else if(TRIAL_COUNT/TRIALS_PER_BLOCK==1){
        $('body').html(function(){
          var score = getScore();
          return "<p>Let's take a look at how you're doing:</p><ul><li><strong># correct</strong> <span style='color:red;'>"+
        score.num_correct+"</span></li><li><strong>% correct</strong> <span style='color:red;'>"+
        score.percent+"</span></li><li><strong>Average RT</strong> <span style='color:red;'>"+
        getAverageRT()+"</span></li></ul> <p>Nice job! Let's see if you can respond even faster this time around!</p><p>Click <a href='#' id='skippy'>here</a> to continue.</p>";});
        skipOnKey();
        now = Date.now();
        nextTrialArray();
      }else{
        $('body').html(matrix_to_html(buildImageMatrix(stim_ultra,stim_average)));
        now = Date.now();
        nextTrialArray();
      }
    }, 1500);
  });
}

// TODO: Ask questions:
//    - What does "preceded by a 500ms fixation cross" mean?
// TODO: welcome, debreif blocks, inter-experiment RESULTS.
// TODO: 1000ms pause to show/animate correct/incorrect responses
// TODO: finite sets of trials (4 blocks, 30 arrays per block)
// TODO: add and remove event listeners

